<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikSave - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm fixed w-full top-0 z-50">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-2">
                    <img src="https://img.icons8.com/fluency/48/tiktok.png" alt="TikSave Logo" class="h-8 w-8">
                    <span class="text-2xl font-bold text-purple-600">TikSave</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="pointsDisplay" class="font-bold text-purple-600">0 Points</span>
                    <button data-action="buy-points" 
                            class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                        Buy Points
                    </button>
                    <button data-action="sign-out" 
                            class="text-gray-600 hover:text-purple-600">
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-20 pb-12">
        <div class="max-w-6xl mx-auto px-4">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-2xl font-bold mb-4">Generate AI Content</h2>
                
                <!-- Input Form -->
                <form id="generateForm" class="space-y-4">
                    <div>
                        <label for="prompt" class="block text-sm font-medium text-gray-700">Your Prompt</label>
                        <textarea id="prompt" 
                                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500"
                                 rows="4"
                                 placeholder="Describe what you want to generate..."></textarea>
                    </div>
                    <div>
                        <button type="submit" 
                                class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            Generate (1 Point)
                        </button>
                    </div>
                </form>

                <!-- Results Section -->
                <div id="results" class="mt-8 hidden">
                    <h3 class="text-xl font-semibold mb-4">Generated Content</h3>
                    <div id="generatedContent" class="bg-gray-50 rounded-lg p-4"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Message Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 translate-y-full">
        <span id="toastMessage"></span>
    </div>

    <script>
        // Initialize Firebase first, before any other code
        let auth;
        let db;
        let stripe;
        let currentUser = null;

        // Wrap initialization in a function
        async function initializeFirebase() {
            const firebaseConfig = {
                apiKey: "AIzaSyCmToewamZs5HVBMpWWnAnlafjolZdWJK8",
                authDomain: "test-d4c13.firebaseapp.com",
                projectId: "test-d4c13",
                storageBucket: "test-d4c13.appspot.com",
                messagingSenderId: "771743673319",
                appId: "1:771743673319:web:61e563fa2f5f98a6beeb42"
            };

            try {
                // Check if Firebase is already initialized
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                auth = firebase.auth();
                db = firebase.firestore();
                
                // Configure Firestore settings
                db.settings({
                    cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
                });

                return new Promise((resolve) => {
                    const unsubscribe = auth.onAuthStateChanged((user) => {
                        unsubscribe();
                        currentUser = user;
                        if (user) {
                            loadUserData();
                        } else {
                            window.location.href = '/auth';
                        }
                        resolve();
                    });
                });
            } catch (error) {
                console.error('Firebase initialization error:', error);
                throw error;
            }
        }

        // Update the initialization order
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Initialize Firebase first
                await initializeFirebase();
                
                // Then initialize Stripe
                await initializeStripe();
            } catch (error) {
                console.error('Initialization error:', error);
                showMessage('Failed to initialize application');
            }
        });

        // Update Stripe initialization
        async function initializeStripe() {
            try {
                console.log('Initializing Stripe...');
                const response = await fetch('/api/config');
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (!data.publishableKey) {
                    throw new Error('No publishable key returned');
                }

                stripe = Stripe(data.publishableKey);
                console.log('Stripe initialized successfully');
            } catch (error) {
                console.error('Stripe initialization error:', error);
                showMessage('Failed to initialize payment system');
                throw error;
            }
        }

        // Show message function
        function showMessage(message, type = 'error') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.classList.remove('translate-y-full');
            
            setTimeout(() => {
                toast.classList.add('translate-y-full');
            }, 3000);
        }

        // Load user data
        async function loadUserData() {
            try {
                if (!currentUser || !currentUser.uid) {
                    console.warn('No current user');
                    return;
                }

                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    document.getElementById('pointsDisplay').textContent = `${userData.points || 0} Points`;
                } else {
                    // Create user document if it doesn't exist
                    await db.collection('users').doc(currentUser.uid).set({
                        email: currentUser.email,
                        points: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    document.getElementById('pointsDisplay').textContent = '0 Points';
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showMessage('Error loading user data');
            }
        }

        // Purchase points function
        async function purchasePoints(points, amount) {
            try {
                if (!currentUser) {
                    throw new Error('User not authenticated');
                }

                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: currentUser.uid,
                        points,
                        amount,
                        email: currentUser.email
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Failed to create checkout session');
                }

                const { url } = await response.json();
                if (url) {
                    window.location.href = url;
                }
            } catch (error) {
                console.error('Purchase error:', error);
                showMessage(error.message);
            }
        }

        // Event Listeners
        document.querySelector('[data-action="buy-points"]').addEventListener('click', () => {
            purchasePoints(100, 10); // 100 points for $10
        });

        document.querySelector('[data-action="sign-out"]').addEventListener('click', async () => {
            try {
                await auth.signOut();
                window.location.href = '/auth';
            } catch (error) {
                console.error('Sign out error:', error);
                showMessage('Failed to sign out');
            }
        });
    </script>
</body>
</html>
